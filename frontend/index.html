<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Simulación Microhidráulica</title>

    <!-- Fuente moderna -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js para gráficas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-main: #050816;
            --bg-card: #0f172a;
            --bg-card-soft: #020617;
            --accent: #22c55e;
            --accent-soft: rgba(34, 197, 94, 0.15);
            --text-primary: #e5e7eb;
            --text-muted: #9ca3af;
            --border-subtle: #1f2937;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: radial-gradient(circle at top, #1d283a 0, #020617 50%, #020617 100%);
            color: var(--text-primary);
        }

        .layout {
            display: grid;
            grid-template-columns: 260px 1fr;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            background: linear-gradient(180deg, #020617 0%, #020617 60%, #030712 100%);
            border-right: 1px solid var(--border-subtle);
            padding: 24px 20px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-circle {
            width: 36px;
            height: 36px;
            border-radius: 999px;
            background: radial-gradient(circle, #22c55e, #16a34a);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: #020617;
        }

        .logo-text-title {
            font-size: 15px;
            font-weight: 700;
        }

        .logo-text-sub {
            font-size: 11px;
            color: var(--text-muted);
        }

        .sidebar-section-title {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .sidebar-card {
            background: var(--bg-card-soft);
            border-radius: 12px;
            padding: 14px 14px;
            border: 1px solid var(--border-subtle);
            font-size: 12px;
            color: var(--text-muted);
        }

        .sidebar-footer {
            margin-top: auto;
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Main content */
        .main {
            display: flex;
            flex-direction: column;
            padding: 18px 24px 24px;
            gap: 16px;
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .topbar-left h1 {
            font-size: 20px;
            margin: 0;
        }

        .topbar-left p {
            margin: 4px 0 0;
            font-size: 12px;
            color: var(--text-muted);
        }

        .topbar-actions {
            display: flex;
            gap: 8px;
        }

        button.primary {
            padding: 8px 14px;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #020617;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        button.secondary {
            padding: 8px 14px;
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            background: transparent;
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
        }

        button:hover {
            opacity: 0.95;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1.15fr 1.1fr;
            gap: 16px;
            align-items: start;
        }

        .card {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 14px 14px 16px;
            border: 1px solid var(--border-subtle);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 8px;
        }

        .card-title {
            font-size: 13px;
            font-weight: 600;
        }

        .card-subtitle {
            font-size: 11px;
            color: var(--text-muted);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
            margin-top: 6px;
        }

        .metric {
            background: var(--bg-card-soft);
            border-radius: 10px;
            padding: 8px 10px;
            border: 1px solid #111827;
        }

        .metric-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        .metric-value {
            font-size: 16px;
            margin-top: 2px;
            font-weight: 600;
        }

        .metric-unit {
            font-size: 11px;
            color: var(--text-muted);
            margin-left: 4px;
        }

        .metric-tag {
            margin-top: 4px;
            font-size: 10px;
            color: var(--accent);
        }

        pre {
            background: #020617;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #111827;
            font-size: 11px;
            max-height: 220px;
            overflow: auto;
        }

        canvas {
            background: #020617;
            border-radius: 10px;
        }

        .bottom-row {
            display: grid;
            grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
            gap: 16px;
        }

        .tag-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(148, 163, 184, 0.12);
            border-radius: 999px;
            padding: 2px 8px;
            font-size: 10px;
            color: var(--text-muted);
        }

        .tag-dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: var(--accent);
        }

        @media (max-width: 960px) {
            .layout {
                grid-template-columns: 1fr;
            }
            .sidebar {
                display: none;
            }
            .content-grid,
            .bottom-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <div class="logo-circle">MH</div>
            <div>
                <div class="logo-text-title">MicroHidro Dash</div>
                <div class="logo-text-sub">Simulación académica | Backend FastAPI</div>
            </div>
        </div>

        <div>
            <div class="sidebar-section-title">Proyecto</div>
            <div class="sidebar-card">
                <strong>Simulación de microgeneración hidroeléctrica</strong><br>
                <span style="font-size:11px;">Parte hidráulica + parte eléctrica, orientado a alimentar alumbrado de parqueo.</span>
            </div>
        </div>

        <div>
            <div class="sidebar-section-title">Estado de la API</div>
            <div class="sidebar-card" id="estado-api">
                Verificando conexión...
            </div>
        </div>

        <div class="sidebar-footer">
            Listo para demo en clase. <br>
            <span style="color:#4ade80;">●</span> Backend local: <code>http://127.0.0.1:8000</code>
        </div>
    </aside>

    <!-- Main -->
    <main class="main">
        <!-- Topbar -->
        <div class="topbar">
            <div class="topbar-left">
                <h1>Dashboard de Simulación</h1>
                <p>Visualización en tiempo real de variables hidráulicas y eléctricas generadas por el backend.</p>
            </div>
            <div class="topbar-actions">
                <button class="secondary" onclick="cargarHistorial()">Ver historial</button>
                <button class="primary" onclick="simular()">➕ Nueva simulación</button>
            </div>
        </div>

        <!-- Content grid principal -->
        <div class="content-grid">
            <!-- Tarjetas métricas -->
            <section class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Resumen del último punto de operación</div>
                        <div class="card-subtitle">Variables clave de la parte hidráulica y eléctrica</div>
                    </div>
                    <span class="tag-pill">
                        <span class="tag-dot"></span>
                        Simulación puntual
                    </span>
                </div>

                <div class="metrics-grid">
                    <!-- Hidráulica -->
                    <div class="metric">
                        <div class="metric-label">Caudal</div>
                        <div class="metric-value">
                            <span id="v_caudal">-</span>
                            <span class="metric-unit">L/s</span>
                        </div>
                        <div class="metric-tag">Entrada hidráulica</div>
                    </div>

                    <div class="metric">
                        <div class="metric-label">Presión</div>
                        <div class="metric-value">
                            <span id="v_presion">-</span>
                            <span class="metric-unit">bar</span>
                        </div>
                        <div class="metric-tag">Condición de línea</div>
                    </div>

                    <div class="metric">
                        <div class="metric-label">Altura hidráulica</div>
                        <div class="metric-value">
                            <span id="v_altura">-</span>
                            <span class="metric-unit">m</span>
                        </div>
                        <div class="metric-tag">Columna de agua equivalente</div>
                    </div>

                    <div class="metric">
                        <div class="metric-label">Potencia hidráulica</div>
                        <div class="metric-value">
                            <span id="v_pot_hid">-</span>
                            <span class="metric-unit">W</span>
                        </div>
                        <div class="metric-tag">Potencia disponible</div>
                    </div>

                    <div class="metric">
                        <div class="metric-label">Potencia eléctrica</div>
                        <div class="metric-value">
                            <span id="v_pot_ele">-</span>
                            <span class="metric-unit">W</span>
                        </div>
                        <div class="metric-tag">Salida de generación</div>
                    </div>

                    <div class="metric">
                        <div class="metric-label">Eficiencia global</div>
                        <div class="metric-value">
                            <span id="v_eficiencia">-</span>
                        </div>
                        <div class="metric-tag">Turbina + generador + electrónica</div>
                    </div>
                </div>
            </section>

            <!-- JSON crudo -->
            <section class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Respuesta JSON del backend</div>
                        <div class="card-subtitle">Datos tal como los entrega la API FastAPI</div>
                    </div>
                </div>
                <pre id="salida">{}</pre>
            </section>
        </div>

        <!-- Fila inferior: gráfica + historial -->
        <div class="bottom-row">
            <section class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Histórico de potencia eléctrica</div>
                        <div class="card-subtitle">Evolución de los puntos simulados (W)</div>
                    </div>
                </div>
                <canvas id="graficoPotencia" height="220"></canvas>
            </section>

            <section class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Historial resumido</div>
                        <div class="card-subtitle">Listado de registros almacenados en la base de datos</div>
                    </div>
                </div>
                <pre id="historial">Pulsa "Ver historial" para cargar datos...</pre>
            </section>
        </div>
    </main>
</div>

<script>
    // ==== Configuración de gráfico ====
    let datosPotencia = [];
    let etiquetasTiempo = [];

    const ctx = document.getElementById("graficoPotencia").getContext("2d");

    const grafico = new Chart(ctx, {
        type: "line",
        data: {
            labels: etiquetasTiempo,
            datasets: [{
                label: "Potencia eléctrica (W)",
                data: datosPotencia,
                borderWidth: 2,
                borderColor: "#22c55e",
                backgroundColor: "rgba(34, 197, 94, 0.18)",
                tension: 0.25,
                pointRadius: 2
            }]
        },
        options: {
            responsive: true,
            animation: false,
            plugins: {
                legend: {
                    labels: { color: "#e5e7eb", font: { size: 11 } }
                }
            },
            scales: {
                x: {
                    ticks: { color: "#9ca3af", font: { size: 10 } },
                    grid: { color: "rgba(31,41,55,0.5)" }
                },
                y: {
                    ticks: { color: "#9ca3af", font: { size: 10 } },
                    grid: { color: "rgba(31,41,55,0.5)" }
                }
            }
        }
    });

    // ==== Actualizar panel con datos recibidos ====
    function actualizarPanel(datos) {
        const d = datos.datos;

        document.getElementById("v_caudal").innerText = d.caudal_lps.toFixed(2);
        document.getElementById("v_presion").innerText = d.presion_bar.toFixed(2);
        document.getElementById("v_altura").innerText = d.altura_hidraulica_m.toFixed(2);
        document.getElementById("v_pot_hid").innerText = d.potencia_hidraulica_w.toFixed(2);
        document.getElementById("v_pot_ele").innerText = d.potencia_electrica_w.toFixed(2);
        document.getElementById("v_eficiencia").innerText = (d.eficiencia_sistema * 100).toFixed(0) + " %";

        // Mostrar JSON bruto
        document.getElementById("salida").innerText = JSON.stringify(datos, null, 2);

        // Actualizar gráfico
        datosPotencia.push(d.potencia_electrica_w);
        etiquetasTiempo.push(new Date().toLocaleTimeString());
        grafico.update();
    }

    // ==== Llamar al backend: /simular ====
    async function simular() {
        try {
            const respuesta = await fetch("http://127.0.0.1:8000/simular");
            const datos = await respuesta.json();
            actualizarPanel(datos);
        } catch (err) {
            console.error(err);
            alert("Error al conectar con el backend. ¿Está corriendo uvicorn?");
        }
    }

    // ==== Llamar al backend: /historial ====
    async function cargarHistorial() {
        try {
            const respuesta = await fetch("http://127.0.0.1:8000/historial");
            const datos = await respuesta.json();
            document.getElementById("historial").innerText = JSON.stringify(datos, null, 2);
        } catch (err) {
            console.error(err);
            alert("Error al obtener historial.");
        }
    }

    // ==== Verificar estado de la API al cargar ====
    async function verificarAPI() {
        const estado = document.getElementById("estado-api");
        try {
            const resp = await fetch("http://127.0.0.1:8000/");
            if (resp.ok) {
                estado.innerHTML = '<span style="color:#4ade80;">●</span> Conectado al backend';
            } else {
                estado.innerHTML = '<span style="color:#f97316;">●</span> Respuesta inesperada';
            }
        } catch (e) {
            estado.innerHTML = '<span style="color:#f97316;">●</span> No se pudo conectar. Arranca uvicorn.';
        }
    }

    verificarAPI();
</script>

</body>
</html>
